---
title: "Bennett Institute: Copiloting review 2022"
author: "Lisa Hopcroft"
date: "`r lubridate::today()`"
output:
    bookdown::html_document2:
        number_sections: false
        toc: true
---

```{r setup, include=FALSE, echo=FALSE, warnings=FALSE}
library(tidyverse)
library(readr)
library(knitr)
library(ggplot2)
library(DiagrammeR)
library(glue)
library(flextable)
library(officer)
library(bookdown)
library(here)
library(tibble)

knitr::opts_chunk$set( echo=FALSE, warnings=FALSE, message=FALSE, ft.align="left" )

theme_set(theme_minimal())

```

<style>
    p {margin: 10px 0px 25px; font-size:15px;}
</style>


```{r data_prep}

base_table = readRDS( here::here("dat","base_table.Rds" ) )
jobs = readRDS( here::here( "dat","annotated_jobs.Rds") )
releases = readRDS( here::here( "dat", "annotated_releases.Rds" ) )
copilots = readRDS( here::here( "dat", "copilot_table.Rds" ) )


load( here::here( "dat","report_variables.Rdat" ) )
load( here::here( "dat","sqlite_variables.Rdat" ) )

```


```{r }

external_projects = base_table %>% filter( ! organisation_name %in% internal_organisations )
num_organisations = external_projects %>% pull( organisation_name ) %>% unique() %>% length()
num_projects = external_projects %>% pull( project_name ) %>% unique() %>% length() 

external_projects_list = external_projects %>% pull( project_name ) %>% unique()
external_workspace_list = external_projects %>% pull( workspace_name ) %>% unique()


```


# Quantitative description

The SQLite file was last modified on `r sqlite_file_last_modified`.
Other relevant start/end dates are shown in the table below.

```{r}
dates_to_present = tribble(
    ~variable, ~from, ~to,
    "Applications (submitted)", min( application_submitted_range ), max(application_submitted_range),
    "Applications (approved)", min( application_approved_range ), max(application_approved_range),
    "Workspaces", min(workspace_creation_range), max(workspace_creation_range),
    "Jobs (start)", min(job_start_range), max(job_start_range),
    "Jobs (end)", min(job_stop_range), max(job_stop_range),
    "Releases", min(release_range), max(release_range)
)
kable( dates_to_present )
```

## Overview: numbers of organisations, projects, copilots etc

```{r}
copilot_list = copilots %>% pull( copilot_name ) %>% unique()
num_copilots = copilot_list %>% length
```

We have `r num_copilots` active co-pilots:

```{r results='asis'}
cat(paste('-', copilot_list %>% sort), sep = '\n')
```


```{r}
column_name_map = list(
    organisation_name = "Organisation",
    project_name = "Project",
    project_count = "Number of projects",
    workspace_count = "Number of workspaces",
    total_num_files_released = "Number of files released",
    overall_time_to_release = "Time to first release (in days)",
    release_within_hard_limit = glue("Release within {hard_release_limit} days"),
    release_within_soft_limit = glue("Release within {soft_release_limit} days"),
    release_within_longer_limit = glue("Release within {longer_release_limit} days"),
    release_within_no_limit = glue("Release (no limit)"),
    n_hard_release = glue("Number released within {hard_release_limit} days"),
    perc_hard_release = glue("Percentage released within {hard_release_limit} days"),
    n_soft_release = glue("Number released within {soft_release_limit} days"),
    perc_soft_release = glue("Percentage released within {soft_release_limit} days"),
    n_longer_release = glue("Number released within {longer_release_limit} days"),
    perc_longer_release = glue("Percentage released within {longer_release_limit} days"),
    n_projects_total = glue( "Total numer of projects" ),
    copilot_name = "Co-pilot name",
    days_since_project_created = "Number of days since project was created",
    days_since_first_workspace = "Number of days since first workspace was created",
    project_creation_date = "Date that the project was created",
    first_workspace_start_date = "Date on which the first workspace was created",
    application_submitted_at = "Date on which the application was submitted",
    application_approved_at = "Date on which the application was approved"
)

```

```{r}

projects_assigned_copilots = external_projects %>% filter( copilot_name != "None provided" )

num_projects_assigned_copilots = projects_assigned_copilots %>%
    pull( project_name ) %>% unique() %>% length()

external_releases = releases %>%
    filter( !is.na( release_created_at )) %>%
    filter( project_name %in% external_projects_list ) %>%
    ungroup( ) %>%
    mutate( specific_time_to_release = difftime( release_created_at, first_workspace_start_date ) )

projects_with_outputs = external_releases
    
num_projects_with_outputs = projects_with_outputs %>%
    pull( project_name ) %>% unique() %>% length()

projects_without_outputs = external_projects %>%
    anti_join( projects_with_outputs, by="project_name" )
num_projects_without_outputs = projects_without_outputs %>%
    pull( project_name ) %>% unique() %>% length()

```

Find some overall counts in Table \@ref(tab:overallcounts) below.

```{r}
overall_counts = tribble(
    ~count, ~n,
    "Total number of projects", num_projects,
    "Projects assigned co-pilots", num_projects_assigned_copilots,
    "Projects with outputs", num_projects_with_outputs, 
    "Projects without outputs", num_projects_without_outputs,
    "Number of active copilots", num_copilots, 
   " Number of organisations with pilots", num_organisations 
)

overall_counts %>%
    ### Format table
    flextable( ) %>%
    set_header_labels( values=list(count = "" ) ) %>%
    autofit() %>%
    theme_zebra() %>%
    footnote( i = 5, j = 1,
            value = as_paragraph("We have at least 1 former co-pilot that is not included in the list above"),
            ref_symbols = "a" ) %>%
    set_caption( glue( "Overall counts (as of {sqlite_file_last_modified})" ),
                autonum = run_autonum(seq_id = "tab", bkm = "overallcounts")) 

```


Projects may consist of multiple workspaces. A count of projects and workspaces per
organisation is provided in the Table \@ref(tab:numPKperorg).

```{r}

external_projects %>%
    ###Â Prepare data
    group_by( organisation_name ) %>%
    summarise( project_count = length(unique(project_name)),
                workspace_count = length( unique(workspace_name) ) ) %>%
    arrange( -project_count, organisation_name )%>%
    janitor::adorn_totals() %>%
    ### Format table
    flextable( ) %>%
    set_header_labels( values=column_name_map ) %>%
    autofit() %>%
    theme_zebra() %>%
    set_caption( "Number of projects and workspaces per organisation",
        autonum = run_autonum(seq_id = "tab", bkm = "numPKperorg")) 

```

## Copiloted output releases: how many have there been and how long do they take to generate

### Projects with releases

There are `r num_projects_with_outputs` projects with outputs.

```{r}

projects_without_outputs_details = projects_without_outputs %>%
    ungroup() %>%
    mutate( days_since_project_created = today()-project_creation_date ) %>%
    mutate( days_since_first_workspace = today()-first_workspace_start_date ) %>%
    select( project_name, organisation_name, starts_with( "days_since" )) %>%
    unique() %>%
    arrange( organisation_name ) 

num_recent_projects_without_outputs = projects_without_outputs_details %>%
    filter( days_since_first_workspace <= hard_release_limit ) %>%
    nrow()

```


See Table \@ref(tab:projectReleaseInfo) for the number of files released from each
project and the time (in days) to first release. Summary statistics
for these values are provided in
Tables \@ref(tab:summarynumfilesperproject) and \@ref(tab:summarytimetofirstrelease)
respectively.

Note that the time for the first release is calculated as the number of days between
(1) the first workspace having been created and (2) the first release having been
made (i.e., the release need not originate from the first workspace created for the
project).

```{r}
project_releases_summary = external_releases %>%
    group_by( project_name, organisation_name ) %>%
    summarise(
        total_num_files_released = sum(num_files_in_release, na.rm=TRUE ),
        workspace_first_opened = min( workspace_start_date, na.rm=TRUE ),
        output_first_released = min( release_created_at, na.rm=TRUE ),
        overall_time_to_release = as.numeric(difftime( output_first_released, workspace_first_opened )) ) %>%
    mutate( release_within_hard_limit = overall_time_to_release <= hard_release_limit ) %>%
    mutate( release_within_soft_limit = overall_time_to_release <= soft_release_limit ) %>%
    mutate( release_within_longer_limit = overall_time_to_release <= longer_release_limit ) %>%
    mutate( release_within_no_limit = overall_time_to_release <= Inf ) %>%
    arrange( overall_time_to_release, project_name )
    
project_releases_summary %>%
    select( project_name, organisation_name, total_num_files_released, overall_time_to_release, ends_with("limit")  ) %>%
    flextable( ) %>%
    set_header_labels( values=column_name_map ) %>%
    autofit() %>%
    theme_zebra() %>%
    set_caption( "Project release details: number of files and time to first release",
        autonum = run_autonum(seq_id = "tab", bkm = "projectReleaseInfo"))

```

Summary of number of files released can be seen in Table \@ref(tab:summarynumfilesperproject).


```{r}

summary( project_releases_summary$total_num_files_released ) %>%
    round( digits=1) %>%
    t %>%
    as.data.frame() %>%
    select (-Var1) %>%
    rename( statistic = Var2, value=Freq ) %>%
    flextable() %>%
    set_caption( "Summary statistics for the total number of files released per project",
    autonum = run_autonum(seq_id = "tab", bkm = "summarynumfilesperproject"))

```


A histogram of the number of files **per project** is shown in Figure \@ref(fig:hist-num-files) below.

```{r hist-num-files, fig.cap="Histogram of number of files"}

project_releases_summary %>%
ggplot( aes( x=total_num_files_released ) ) +
geom_histogram() +
ggtitle( "Histogram of number of files released" ) +
xlab("Number of files released")

```

The same data shown as a boxplot Figure \@ref(fig:boxplot-num-files) below.

```{r boxplot-num-files, fig.cap="Boxplot of number of files"}

project_releases_summary %>%
ggplot( aes( x="", y=total_num_files_released ) ) +
geom_boxplot() +
ggtitle( "Boxplot of number of files released" ) +
ylab("Number of files released") +
xlab("") +
scale_y_continuous( breaks=seq(from=0, to=1350, by=100) )

```

Summary of time to release by limits, by year, can be seen in Table \@ref(tab:numreleaselimitsperyear).

```{r}
project_releases_summary %>%
    ungroup() %>%
    mutate( project_releases_summary %>% mutate( year = year(workspace_first_opened)) ) %>%
    group_by( year ) %>%
    summarise( n_hard_release=sum(release_within_hard_limit),
               n_soft_release=sum(release_within_soft_limit),
               n_longer_release=sum(release_within_longer_limit),
               n_projects_total = n() ) %>%
    janitor::adorn_totals() %>%
    mutate( perc_hard_release=round( 100*n_hard_release/n_projects_total,digits=1 ),
            perc_soft_release=round( 100*n_soft_release/n_projects_total,digits=1 ),
            perc_longer_release=round( 100*n_longer_release/n_projects_total,digits=1 ) ) %>%
    select( year, ends_with( "release" ), n_projects_total ) %>%
    flextable() %>%
    autofit() %>%
    theme_zebra() %>%
    set_header_labels( values=column_name_map ) %>%
    set_caption( "Number of releases within limits per year",
    autonum = run_autonum(seq_id = "tab", bkm = "numreleaselimitsperyear"))
```

Summary of time to release by statistics, overall,  can be seen in Table \@ref(tab:summarytimetofirstrelease).

```{r}

summary( as.numeric( project_releases_summary$overall_time_to_release ) ) %>%
    t %>%
    as.data.frame() %>%
    select (-Var1) %>%
    rename( statistic = Var2, value=Freq ) %>%
    mutate( value = round( value, 2 )) %>%
    flextable() %>%
    set_caption( "Summary statistics for the number of days until first release per project",
    autonum = run_autonum(seq_id = "tab", bkm = "summarytimetofirstrelease"))

```

A histogram of the number of days until the first release **per project** is shown in Figure \@ref(fig:hist-time-to-first-release) below.

```{r hist-time-to-first-release, fig.cap="Histogram of time to first release (in days)"}

project_releases_summary %>%
ggplot( aes( x=overall_time_to_release ) ) +
geom_histogram() +
ggtitle( "Histogram of time to release" ) +
xlab("Time to first release (in days)")

```

The same data shown as a boxplot Figure \@ref(fig:boxplot-time-to-first-release) below.

```{r boxplot-time-to-first-release, fig.cap="Boxplot of time to first release (in days)"}

project_releases_summary %>%
ggplot( aes( x="", y=overall_time_to_release ) ) +
geom_boxplot() +
ggtitle( "Boxplot of time to release" ) +
ylab("Time to first release (in days)") +
xlab("") +
scale_y_continuous( breaks=seq(from=0, to=500, by=25))

```

### Projects without releases


Of the `r num_projects_without_outputs` projects without outputs,
`r num_recent_projects_without_outputs` projects were created within the last
`r hard_release_limit` days.

The remaining `r num_projects_without_outputs-num_recent_projects_without_outputs`
projects are listed in Table \@ref(tab:projectsWithoutReleasesDetails).

```{r results='asis'}

projects_without_outputs_details %>%
    filter(days_since_first_workspace > hard_release_limit ) %>%
    arrange( -days_since_project_created ) %>%
    flextable() %>%
    set_header_labels( values=column_name_map ) %>%
    autofit() %>%
    theme_zebra() %>%
    set_caption( "Projects without releases",
    autonum = run_autonum(seq_id = "tab", bkm = "projectsWithoutReleasesDetails"))


```


## Applications

Note that application review time is calculated as the number of days between:
the *application submission date* (`applications_application.submitted_at`) and
the *application approved date* (`applications_application.approved_at`).

The field `applications_application.submitted_at` was
[added on 13th December 2022](https://github.com/opensafely-core/job-server/commit/680f40ff1a5e99eafc4b0b8330e9b7e1d7078d79)
so we will only have this data for applications submitted after this date.

We also need to bear in mind that early projects would have been approved
and administered using the old 'paper'-based system; the intention is to
add these to the database over time, but this may not be complete and/or
dates may only reflect the date on which they are added to the system.

```{r}

external_projects_list_ids = external_projects %>% pull( project_id ) %>% unique()
projects_with_applications_ids = application_table %>% pull( project_id ) %>% unique()

num_external_projects_with_applications_data = (external_projects_list_ids %in% projects_with_applications_ids) %>% sum
perc_external_projects_with_applications_data = round(100*(num_external_projects_with_applications_data/num_projects),digits=1)

```

Of the `r num_projects` external projects, `r num_external_projects_with_applications_data`
(`r perc_external_projects_with_applications_data`%)
are represented in the applications table.

Those that are not are listed below (in order form the oldest to the newest):

```{r}
external_projects %>% anti_join( application_table, by="project_id" ) %>%
    ungroup() %>%
    select( project_name, organisation_name, project_creation_date,
            first_workspace_start_date ) %>%
    unique() %>%
    arrange( project_creation_date ) %>%
    flextable( ) %>%
    set_header_labels( values=column_name_map ) %>%
    autofit() %>%
    theme_zebra() %>%
    set_caption( "External projects for which we have no applications data",
        autonum = run_autonum(seq_id = "tab", bkm = "extProjNoAppData"))
```

Not all of the `r num_external_projects_with_applications_data` external applications have
an approved date, and some have an invalid entry (in that the submission date is after the approved date):

```{r}

external_applications = application_table %>% filter( project_id %in% external_projects_list_ids )

num_application_with_submit_date = external_applications %>% filter( !is.na(application_submitted_at)) %>% nrow
num_application_with_approved_date = external_applications %>% filter( !is.na(application_approved_at)) %>% nrow
num_application_with_negative_delay = external_applications %>% filter( days_to_approve_application < 0) %>% nrow

application_counts = tribble(
    ~count, ~n,
    "Applications (n)", external_applications %>% nrow,
    "With submission date", num_application_with_submit_date,
    "With approved date", num_application_with_approved_date,
    "With submission after approve", num_application_with_negative_delay
)
kable( application_counts )

```

Those that do not have an approved date are as follows:

```{r}

external_projects %>% merge( external_applications, by="project_id" ) %>%
    filter( is.na(application_approved_at)) %>%
    ungroup() %>%
    select( project_name, organisation_name, project_creation_date,
            first_workspace_start_date,
            application_submitted_at ) %>%
    unique() %>%
    arrange( project_creation_date ) %>%
    flextable( ) %>%
    set_header_labels( values=column_name_map ) %>%
    autofit() %>%
    theme_zebra() %>%
    set_caption( "External projects that have an application yet to be approved",
        autonum = run_autonum(seq_id = "tab", bkm = "extProjNoAppApproval"))

```

Of the remaining `r num_application_with_approved_date` applications,
`r num_application_with_negative_delay` have an approved date *after*
the submission date.

```{r}

external_projects %>% merge( external_applications, by="project_id" ) %>%
    filter( !is.na(application_approved_at)) %>%
    filter( days_to_approve_application < 0 ) %>%
    ungroup() %>%
    select( project_name, organisation_name, project_creation_date,
            first_workspace_start_date,
            application_submitted_at ) %>%
    unique() %>%
    arrange( project_creation_date ) %>%
    flextable( ) %>%
    set_header_labels( values=column_name_map ) %>%
    autofit() %>%
    theme_zebra() %>%
    set_caption( "External projects where approval happens before creation",
        autonum = run_autonum(seq_id = "tab", bkm = "extProjApprovalBeforeCreation"))
```

```{r}
external_projects_with_valid_completed_applications = external_projects %>%
    merge( external_applications, by="project_id" ) %>%
    filter( !is.na(application_approved_at)) %>%
    filter( days_to_approve_application >= 0 )

```

So we have valid, completed application data for
`r external_projects_with_valid_completed_applications %>% nrow`
projects.


```{r}
external_projects_with_valid_completed_applications %>%
    ungroup() %>%
    select( project_name, organisation_name, project_creation_date,
            first_workspace_start_date,
            application_submitted_at ) %>%
    unique() %>%
    arrange( project_creation_date ) %>%
    flextable( ) %>%
    set_header_labels( values=column_name_map ) %>%
    autofit() %>%
    theme_zebra() %>%
    set_caption( "External projects with valid, completed applications",
        autonum = run_autonum(seq_id = "tab", bkm = "extProjApprovalValid"))

```

Summary statistics for the number of days to application approval

```{r}

summary( external_projects_with_valid_completed_applications$days_to_approve_application %>% as.numeric ) %>%
    t %>%
    as.data.frame() %>%
    select (-Var1) %>%
    rename( statistic = Var2, value=Freq ) %>%
    mutate( value = round( value, digits=1 )) %>%
    flextable() %>%
    set_caption( "Summary statistics for number of days to application approval",
    autonum = run_autonum(seq_id = "tab", bkm = "summaryappapproval"))

```

The same value is represented below in a histogram.

```{r}
ggplot( external_projects_with_valid_completed_applications, aes(x=days_to_approve_application) ) +
geom_histogram()

```